---
title: React 18å‰ç»
categories:
  - code
  - frontend
tags:
  - react
---



## ç®€ä»‹

React 18 çš„æ‰€æœ‰æ–°ç‰¹æ€§åŸºæœ¬å¯ä»¥å½’ä¸ºä¸‹é¢ä¸¤ç±»ï¼š

1. å¹¶å‘æ¸²æŸ“ã€‚ä¸ºäº†è§£å†³å¤§é‡DOMèŠ‚ç‚¹åŒæ—¶æ›´æ–°é€ æˆçš„æ¸²æŸ“å»¶è¿Ÿé—®é¢˜ï¼Œä»¥åŠå­ç»„ä»¶IOæ“ä½œè¢«çˆ¶ç»„ä»¶é˜»å¡çš„é—®é¢˜ã€‚Reactæ–°çš„Fiber Reconcileré€šè¿‡å°†ä»»åŠ¡æ‹†åˆ†æˆå°å—ï¼Œæ”¯æŒäº†å¹¶å‘æ¸²æŸ“ã€‚æ—¢ï¼šå…è®¸ReactåŒæ—¶æ¸²æŸ“å¤šç‰ˆæœ¬çš„UIã€‚
2. æ–°SSRæ¶æ„ã€‚å…è®¸ç”¨æˆ·å°†åº”ç”¨æ‹†åˆ†ä¸ºæ›´å°çš„å•å…ƒï¼Œä½¿æ¯ä¸ªå•å…ƒå…·å¤‡ç‹¬ç«‹çš„fetch data (server) â†’ render to HTML (server) â†’ load code (client) â†’ hydrate (client)æµç¨‹ã€‚

## æ–°ç‰¹æ€§

### å¹¶å‘æ¸²æŸ“

åœ¨æ›´æ—©çš„æ—¶å€™ï¼Œreactæå‡ºäº†å®éªŒæ€§çš„ç‰¹æ€§[concurrent mode](https://reactjs.org/docs/concurrent-mode-intro.html)ã€‚é€šè¿‡concurrent modeså®ç°äº†å¹¶å‘çš„çŠ¶æ€æ›´æ–°ï¼Œè¿™é‡Œçš„å¹¶å‘æœ‰ä¸¤ç§å†…å«ï¼š

1. å¯¹äºCPUç›¸å…³çš„æ›´æ–°ï¼ˆå¦‚åˆ›å»ºDOMèŠ‚ç‚¹ï¼Œæ‰§è¡Œç»„ä»¶ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼‰ï¼Œè¿™æ„å‘³ç€é«˜ä¼˜çš„æ›´æ–°èƒ½å¤Ÿæ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„æ›´æ–°ã€‚
2. å¯¹äºIOç›¸å…³çš„æ›´æ–°ï¼ˆå¦‚è¯·æ±‚æ•°æ®ï¼‰ï¼Œè¿™æ„å‘³ç€åœ¨æ•°æ®è¿”å›å‰å¯ä»¥åœ¨å†…å­˜ä¸­æå‰è¿›è¡Œæ¸²æŸ“ã€‚

åœ¨react 18çš„[post](https://reactjs.org/blog/2021/06/08/the-plan-for-react-18.html)ä¸­ï¼Œä½œè€…å°†å…¶é‡æ–°å‘½åä¸º"concurrent rendering"ã€‚æ„å‘³ç€react18ä¸­å¹¶å‘ä¸å†æ˜¯ä»¥ä¸€ç§å¿…é¡»é€‰æ‹©çš„ä½œç”¨äºå…¨å±€çš„æ¨¡å¼ï¼ˆall-or-nothing â€œmodeâ€ï¼‰ï¼Œè€Œæ˜¯åªä¼šåœ¨éœ€è¦æ—¶è¢«æ–°ç‰¹æ€§è§¦å‘çš„ç‰¹æ€§ã€‚è¿™ä¹Ÿå’Œreact18çš„æ¸è¿›å¼å‡çº§ç­–ç•¥ç›¸å…³è”ã€‚

#### CPU-bounded updates

ä¸ºäº†æå‡è¿è¡Œæ€§èƒ½å’Œç”¨æˆ·ä½“éªŒï¼Œreactä¿®æ”¹æ¸²æŸ“çš„è°ƒåº¦æœºåˆ¶ï¼Œè¿™ä¸»è¦åŒ…å«ä¸¤ç‚¹ï¼š

1. å°†ä¸€æ¬¡æ¸²æŸ“åˆ†ç‰‡ï¼Œå…è®¸å¤šæ¬¡æ¸²æŸ“å¹¶å‘æ‰§è¡Œï¼Œä¹Ÿæ”¯æŒæ¸²æŸ“çš„æ‰“æ–­
2. å¯¹æ¸²æŸ“åŒºåˆ†ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆæ‰§è¡Œé«˜ä¼˜æ¸²æŸ“ä»»åŠ¡

##### åˆ†ç‰‡

è¿™ä¸ªèƒ½åŠ›å†react 16å¼•å…¥çš„Fiber Reconcilerä¸­å°±å·²å®ç°ã€‚åœ¨æ­¤ä¹‹å‰reactä½¿ç”¨çš„æ˜¯Stack Reconcilerï¼Œå®ƒä½¿ç”¨é€’å½’çš„æ–¹å¼å¯¹æ•´æ£µæ ‘è¿›è¡Œæ¸²æŸ“

stack reconciler & fiber reconciler https://zhuanlan.zhihu.com/p/109971435 TODO

##### ä¼˜å…ˆçº§

react18å°†çŠ¶æ€æ›´æ–°åˆ†ä¸ºä¸¤ä¸ªç±»åˆ«ï¼ˆä¼˜å…ˆçº§ï¼‰ï¼š

1. Urgent updatesï¼šéœ€è¦å¿«é€Ÿåé¦ˆçš„äº¤äº’ï¼Œå¦‚ï¼šé”®ç›˜è¾“å…¥ã€ç‚¹å‡»ã€è§¦æ‘¸ç­‰
2. Transition updatesï¼šUIä»ä¸€ä¸ªè§†å›¾åˆ°å¦ä¸€ä¸ªè§†å›¾çš„è½¬æ¢

æ¯”å¦‚ï¼šåœ¨ä¸€ä¸ªcmsçš„è¡¨æ ¼åœºæ™¯ä¸­ï¼Œå½“ç”¨æˆ·é€‰ä¸­ä¸€ä¸ªä¸‹æ‹‰æ¡†çš„é€‰é¡¹æ¥è¿‡æ»¤åˆ—è¡¨çš„æ—¶å€™ã€‚ç”¨æˆ·æœŸæœ›åœ¨ç‚¹å‡»é€‰é¡¹åä¸‹æ‹‰æ¡†å¿«é€Ÿæ”¶èµ·å¹¶æ›´æ–°é€‰ä¸­é¡¹ï¼ˆurgent updatesï¼‰ï¼Œä½†æ˜¯çœŸå®çš„è¿‡æ»¤åçš„åˆ—è¡¨æ— éœ€å³æ—¶å˜åŒ–ï¼ˆtransition updatesï¼‰ã€‚

åœ¨18ä¹‹å‰ï¼Œæ‰€æœ‰çš„çŠ¶æ€æ›´æ–°éƒ½æ˜¯urgent updatesï¼Œä½†å®é™…ä¸Šå¾ˆå¤šåœºæ™¯åœ¨18ä¸­å¯ä»¥å½’ç±»ä¸ºtransition updatesã€‚ä½†ä¸ºäº†å‘åå…¼å®¹ï¼Œtransition updatesè¢«ä½œä¸ºä¸€ä¸ªå¯é€‰çš„ç‰¹æ€§ï¼Œåªæœ‰å½“ç”¨æˆ·ä½¿ç”¨å¯¹åº”çš„APIè§¦æ³•çŠ¶æ€æ›´æ–°çš„æ—¶å€™æ‰ä¼šè¢«ä½¿ç”¨ã€‚

**API**

è¿™ä¸ªæ–°çš„APIå°±æ˜¯`startTransition`ï¼š

```js
import { useTransition } from 'react';


const [isPending, startTransition] = useTransition();

// Mark any state updates inside as transitions
startTransition(() => {
  setState(input);
});
```

useTransition hook è¿”å›äº†ï¼š

1. isPendingï¼šè¡¨ç¤ºå½“å‰çš„çŠ¶æ€æ›´æ–°è¿˜æœªè¢«åæ˜ ï¼ˆæ¸²æŸ“ï¼‰åˆ°è§†å›¾ä¸Š
2. startTransitionï¼šç”¨äºè§¦å‘transition updates
   - startTransitionä¼šè¢«åŒæ­¥æ‰§è¡Œï¼Œä½†æ˜¯è¿™ä¸ªæ›´æ–°ä¼šè¢«æ ‡è®°ï¼Œåœ¨æ›´æ–°è¢«å¤„ç†æ—¶reactä¼šä»¥æ­¤åˆ¤æ–­å¦‚ä½•æ¸²æŸ“æ›´æ–°
   - æ¸²æŸ“æ—¶ï¼ŒstartTransitioné€ æˆçš„æ›´æ–°æ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ï¼Œå®ƒä¸ä¼šblocké¡µé¢ã€‚å½“ç”¨æˆ·çš„è¾“å…¥æ”¹å˜åï¼Œreactå°†ä¸ä¼šç»§ç»­æ¸²æŸ“è¿‡æœŸçš„æ›´æ–°

**åº”ç”¨åœºæ™¯**

åœ¨ä»¥ä¸‹çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨`startTransition`APIæ¥æ›¿ä»£ä¹‹å‰çš„çŠ¶æ€æ›´æ–°APIï¼š

1. Slow renderingï¼šå½“ä¸€ä¸ªæ›´æ–°éœ€è¦æ¶ˆè€—å¤§é‡è®¡ç®—èµ„æºçš„æ—¶å€™
2. Slow networkï¼šå½“ä¸€ä¸ªæ›´æ–°éœ€è¦reactç­‰å¾…æ¥å£è¿”å›æ•°æ®çš„æ—¶å€™

å¯ä»¥è¿™ä¹ˆè®¤ä¸ºï¼šå½“ä¸€ä¸ªæ›´æ–°æœ¬èº«å°±éœ€è¦è€—è´¹ä¸€äº›ç­‰å¾…æ—¶é—´ï¼ˆç­‰å¾…å¯èƒ½æ˜¯æ¥æºäºå¤§é‡è®¡ç®—çš„å¼€é”€æˆ–ç½‘ç»œçš„ç­‰å¾…ï¼‰æ—¶ï¼Œé‚£ä¹ˆç”¨æˆ·ä¸ä¼šåœ¨ä¹ä¸ºè¿™ä¸ªæ›´æ–°å†å¤šç­‰å¾…ä¸€äº›æ—¶é—´ï¼Œæ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨startTransition APIã€‚ä»¥æ­¤ï¼Œå¯ä»¥å°†è®¡ç®—èµ„æºæ›´å¤šåœ°æä¾›ç»™urgent updatesæ¥æå‡ç”¨æˆ·ä½“éªŒã€‚

> react18å’Œä¹‹å‰ç‰ˆæœ¬çš„æ€§èƒ½æ¯”è¾ƒå¯ä»¥è§ [è¿™ä¸ªæ¡ˆä¾‹](https://github.com/reactwg/react-18/discussions/65)

#### IO-bounded updates



#### Break Change

éƒ¨åˆ†ç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œæ—¶æœºå’Œæ¬¡æ•°å°†ä¼šå‘ç”Ÿæ”¹å˜ã€‚æˆ‘ä»¬å¯ä»¥å°†reactçš„ç”Ÿå‘½å‘¨æœŸåˆ†ä¸ºä¸¤ç±»ï¼šrender phaseï¼ˆæ¸²æŸ“é˜¶æ®µï¼‰å’Œcommit phaseï¼ˆæäº¤é˜¶æ®µï¼‰ï¼Œè¯¦è§[react-lifecycle-methods-diagram](https://projects.wojtekmaj.pl/react-lifecycle-methods-diagram/)ã€‚åœ¨å¹¶å‘æ¸²æŸ“æ—¶ï¼Œä¸€ä¸ªç»„ä»¶çš„æ›´æ–°å¯èƒ½ä¼šè¢«æ‰“æ–­ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šè¢«é‡æ–°æ¢å¤ï¼Œè¿™å°±å¯¼è‡´äº†ä¸€ä¸ªæ¸²æŸ“é˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½ä¼šè¢«å¤šæ¬¡æ‰§è¡Œï¼Œé€ æˆåˆ‡æ¢åˆ°å¹¶å‘æ¸²æŸ“åç»„ä»¶å‘ç”Ÿé¢„æœŸå¤–çš„è¡¨ç°ã€‚å› æ­¤åœ¨å°†æ—§ç»„ä»¶å‡çº§ä¸ºå¹¶å‘æ¸²æŸ“æ—¶ï¼Œéœ€è¦æ³¨æ„ï¼š

1. å°†render phaseç”Ÿå‘½å‘¨æœŸå›è°ƒæ”¾åˆ°commit phaseçš„å›è°ƒä¸­æ‰§è¡Œã€‚
2. æˆ–ä¿è¯render phaseæ‰§è¡Œçš„é€»è¾‘æ˜¯[å¹‚ç­‰](https://en.wikipedia.org/wiki/Idempotence#Computer_science_meaning)çš„ã€‚å³è¯¥å›è°ƒä¸­çš„side effectï¼Œ**å¤šæ¬¡æ‰§è¡Œ**ä¸**å•æ¬¡æ‰§è¡Œ**å¯¹ç³»ç»ŸçŠ¶æ€çš„å½±å“**ç›¸åŒ**ã€‚

åœ¨å¼€å‘é˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

1. é€šè¿‡Reactçš„[Strict Mode](https://reactjs.org/docs/strict-mode.html#detecting-unexpected-side-effects)æ¥æ£€æµ‹è¿™äº›æ½œåœ¨çš„é”™è¯¯ï¼ˆStrict Modeå¹¶éç›´æ¥æ£€æµ‹å‰¯ä½œç”¨ï¼Œè€Œæ˜¯å°†è¿™äº›ç”Ÿå‘½å‘¨æœŸçš„å›è°ƒæ‰§è¡Œä¸¤æ¬¡ä»¥ä¾¿äºç”¨æˆ·å‘ç°éå¹‚ç­‰çš„å‰¯ä½œç”¨ï¼‰
2. ä¸å†ä½¿ç”¨componentWillMountç­‰ç”Ÿå‘½å‘¨æœŸï¼Œè¿™äº›ç”Ÿå‘½å‘¨æœŸçš„æ›¿ä»£æ–¹æ¡ˆå¯ä»¥å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://reactjs.org/docs/react-component.html#legacy-lifecycle-methods)ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆReact16.9å°†è¿™äº›å‡½æ•°å‘½åä¸ºUNSAFE_componentWillMountç­‰ï¼Œå¹¶åœ¨æ§åˆ¶å°æ‰“å°è­¦å‘Šï¼‰

### createRoot

### automatic batching

### startTransition

### new streaming server renderer

## æ¸è¿›å¼å‡çº§

ä»…ç®¡

## é‡Œç¨‹ç¢‘

- 2021-06-08 å‘å¸ƒalphaåŒ…
- 2021-11-15 å‘å¸ƒbetaåŒ…

## References

- [The Plan for React 18](https://reactjs.org/blog/2021/06/08/the-plan-for-react-18.html)
- [React 18 å°±è¦æ¥äº†ï¼Œæ¥çœ‹çœ‹å‘å¸ƒè®¡åˆ’ ğŸ¤©](https://zhuanlan.zhihu.com/p/379072979)
- [ç†è§£ React Fiber & Concurrent Mode](https://zhuanlan.zhihu.com/p/109971435)
- [Introducing Concurrent Mode (Experimental)](https://reactjs.org/docs/concurrent-mode-intro.html)
- [Legacy Lifecycle Methods](https://reactjs.org/docs/react-component.html#legacy-lifecycle-methods)
